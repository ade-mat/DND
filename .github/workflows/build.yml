# https://cloud.google.com/run/docs/securing/identity-aware-proxy-cloud-run?_gl=1*1hsi7mj*_ga*NzIxMTQyMTk0LjE3NDA0ODM0MjQ.*_ga_WH2QY8WWF5*czE3NjEyMzY2NzQkbzY1MiRnMSR0MTc2MTIzODgxMiRqMjckbDAkaDA.#gcloud_2
# https://cloud.google.com/sdk/gcloud/reference/beta/run/deploy

name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: newsite-4cb22
  GAR_LOCATION: europe-west2
  REPOSITORY: github-docker-repo
  IMAGE: dnd-web
  CLOUD_RUN_SERVICE: dnd
  CLOUD_RUN_REGION: europe-west2
  WORKLOAD_IDENTITY_PROVIDER: projects/193435249823/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT_EMAIL: github-actions-deployer@newsite-4cb22.iam.gserviceaccount.com

jobs:
  build-publish-deploy:
    name: Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: 'actions/checkout@v4'

      - id: 'auth'
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ env.SERVICE_ACCOUNT_EMAIL }}'
          token_format: 'access_token' # For OAuth 2.0 access tokens, specify "access_token"
          # id_token_audience: 'https://oauth2.googleapis.com/token'
          # id_token_include_email: true


      - name: Set up gcloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          version: '>= 440.0.0'
          install_components: 'beta'

      - name: Configure gcloud defaults
        run: |
          gcloud config set project "${PROJECT_ID}"

      # Authenticate Docker to Google Cloud Artifact Registry
      - name: Docker Auth
        uses: 'docker/login-action@v3'
        with:
          username: oauth2accesstoken
          password: '${{ steps.auth.outputs.access_token }}'
          registry: '${{ env.GAR_LOCATION }}-docker.pkg.dev'

      - name: Define image name
        run: |
          IMAGE_URI=${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE}:${GITHUB_SHA}
          echo "IMAGE_URI=${IMAGE_URI}" >> "${GITHUB_ENV}"
          echo "Built image: ${IMAGE_URI}"

      - name: Build container image
        env:
          CLIENT_ENV: |
            VITE_FIREBASE_API_KEY=${{ secrets.VITE_FIREBASE_API_KEY }}
            VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
            VITE_FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}
            VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
            VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
            VITE_FIREBASE_APP_ID=${{ secrets.VITE_FIREBASE_APP_ID }}
        run: |
          DOCKER_BUILDKIT=1 docker build \
            --tag "${IMAGE_URI}" \
            --secret id=vite_client_env,env=CLIENT_ENV \
            --file Dockerfile \
            .

      - name: Push image to Artifact Registry
        run: |
          docker push "${IMAGE_URI}"

      - name: Deploy to Cloud Run
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID_SECRET: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          FIREBASE_SERVICE_ACCOUNT_B64="$(printf '%s' "${FIREBASE_SERVICE_ACCOUNT}" | base64 -w0)"

          gcloud beta run deploy "${CLOUD_RUN_SERVICE}" \
            --image="${IMAGE_URI}" \
            --region="${CLOUD_RUN_REGION}" \
            --no-allow-unauthenticated \
            --ingress=internal \
            --session-affinity \
            --scaling=auto \
            --network=default \
            --subnet=default \
            --set-env-vars "FIREBASE_SERVICE_ACCOUNT=${FIREBASE_SERVICE_ACCOUNT_B64},FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID_SECRET}" \
            --quiet

          gcloud run services add-iam-policy-binding "${CLOUD_RUN_SERVICE}" \
            --member="user:Kidfury124@gmail.com" \
            --role="roles/run.invoker" \
            --region="${CLOUD_RUN_REGION}" \
            --project="${PROJECT_ID}"

          gcloud beta run services describe "${CLOUD_RUN_SERVICE}" \
            --region="${CLOUD_RUN_REGION}"
